# BiYong商户平台通信规范

## 商户平台升级

商户平台升级后，每个商户可以创建多个App。

请求头中的 MerchantId 字段变更为 AppId 字段。MerchantId 字段兼容旧版字段仍然可以使用。

## SDK

[JAVA SDK](https://github.com/openbiyong/biyong-open-api-java)

[PHP SDK](https://github.com/openbiyong/biyong-open-api-php)

## 通信规范

所有接口调用均采用 https post

需要填写 headers:

|key|value|备注|
|---|---|---|
|Content-Type|application/json|传参格式为JSON
|AppId|d4743d2bd449468383a5417efa423541|AppID|

### 1. 发送 Request

- 商户请自行生成RSA秘钥对，将公钥上传至BiYong商户后台。此文档假设私钥-公钥对如下：


商户RSA私钥 (Base64-RFC4648):

    MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCGdHa2BsE65r/3YvzhGpsikKp7GsaFpKDex1Fzls8rxFfpa1NhZrwpsjJ09hmp0fwjxbcX8Qe6w7ndH5Sl1f6w5iwPebClKmX+Lfjz36dOBLVhnMfi6xdIKQ4lHNMQPKYE8GLJu7WuUqbeNWEUk73stjtyTFj8rvuzUZioM5YzWMleBvw353VRziOjbYFwrcilopT6EscJ0sB6WR5i4fF8AsFzeEO3FuJKyDGphcBXUN8VDpS2qb2LyZeVYKQVC6Sey7nYfOxIdJMM0dA6RLbi3bU4To6FKTk+3JRIOzQJpSCK+doZHi3aKLSmx5oKgNJf3BLsGJBegcPPDpzGDTodAgMBAAECggEAdaxGHQcKZE+BYLTMlwIfFgBAhB8p8drkRDVzLtOlGyvquMoKnms4cNGZYU3lpf+2SWSH2rdDSYx1BXbXNNB16EJ5+01IcTULMIrxoBZ0qU5rpDN/qTSRGsF7tLVmb4Z00kvEWcQjvJ5vlnhnL4giJ6JRorX5B6TpesYF8ee8I9DU4iQ/qJ8IsqAbFOwQGNXeIYTLMTKob2y68YWdRdi13TYRunDhDw9bb8qfi6Ckp9563SCwb04jp+0SiRhBG6rQQzVSMBHla58NF4xDSO22s9Or995JUOzhkrngqjP5WXZnbZwwbwduf4gz3cPONDGnfS9jaCfhnl0lIEbyeSJ9oQKBgQD5QNIhDBYqxjk6ptjjKKGvXyggzZ5JpFYrGHgyDJjVc4SeqPkBhrVg6xut38UJmJ40tLht3fFUnfgGzFUIg8mCiZPDb3v+UFIDtGdUvg8T9b1THRcfqN2Q2b9nADnbljumk7koKrME2DVp9cZD7ltrjMayXK/b75pibw1hhljflQKBgQCKGChtQ3zXFPUpcxfcW2sDziPPPy3cM1GXdOYJ/S5MxuVylCQBMxRNSWJPtaGqgkBN493i5dAjBl9O44kq5+Lo1RZyMDr8U0go62PVNH+DocDmvTAHFFy/+eiZB1/LexgrYYL3LZQ4TtF1V7XAPyE/bY2yCzN6EN5AM7u3kYnuaQKBgQDbY9/Q8MeOLN3wry1WfMwcBcDXZsT9guXJlwcs3oOj1cMUuBw86Ko7vZWmbMENGkWelLeFFQa3eTf4G+B41y8GdDwYmMdl6KLX2fHd2FCDPBjB0GgrGMK1HcRoT/2dN1YX4AzouvTJvdj+BDPYVTQorUezdPvhtbuJCsCXZ95QJQKBgB4/amN8e9TUt1qL5jcTIx6jQX68tPvdlcqaBWU8uq6AhnORdU159cF0CH+zJiUmAJXPCqQPeIajd67c8gee4TnkqtT6MYFhcJXd8XEa3a9kd89SszlpwWMfh041qkr0vHeMFVa0+hlXUlPkkV/5s/ujsHzGLVFYboYbjsuHqnG5AoGBAPU7WoSEZwwV3yQh2m/wsM0A+He/gKuqSd4JV8XNYzPeGLYmBQAoLvm8qJW4n1oJprk4S2zitOKRMTev/UXkkUSVHrOnzlSjZ33yd3ODIjkNWRFP03i5O4rX5MWCctQNMBg/ZJcbi8qGB2WDR6+3be4uf7zJOWAOonjv3bTiN0Ai
    
商户RSA公钥 (Base64-RFC4648):

    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAhnR2tgbBOua/92L84RqbIpCqexrGhaSg3sdRc5bPK8RX6WtTYWa8KbIydPYZqdH8I8W3F/EHusO53R+UpdX+sOYsD3mwpSpl/i3489+nTgS1YZzH4usXSCkOJRzTEDymBPBiybu1rlKm3jVhFJO97LY7ckxY/K77s1GYqDOWM1jJXgb8N+d1Uc4jo22BcK3IpaKU+hLHCdLAelkeYuHxfALBc3hDtxbiSsgxqYXAV1DfFQ6Utqm9i8mXlWCkFQuknsu52HzsSHSTDNHQOkS24t21OE6OhSk5PtyUSDs0CaUgivnaGR4t2ii0pseaCoDSX9wS7BiQXoHDzw6cxg06HQIDAQAB
    
BiYongRSA私钥 (Base64-RFC4648):

    MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDkSN1u1rfjMdgS/Xsv6DYcBE/29K7jnYo40IGGIrqWNKH+8WxIa4hjtBy0skzgdNzBWx2WezJYbW0TOctFhBsln/r8GUdvb+jHnCqLFihR/oFVwBDHliizLnQokrb0uZjyKbjtk6o5dILF6Jpa6iVO3SRWxxbkoH4b6f7dwiyn5WjB/wcXyf9VMEAq3005imEopKwtzSfhpGw9rO45tyJM1e5dFv5uEpfg6Qf85pnCobh8BwJkv1ZedSiounyKr6zvmyTG3UdyUvsiCgONalaytlH/+IxlKz+KXTwNR2HK4rH5BYoCjR8GhUCMFB/9cRlqEyqDm1f/QzW5APNcwLbdAgMBAAECggEAbZEnbo5yHgKLYbn1yS2b4uCS/MW9txOjBtfUguviQDus0O9Q+IVcJfaJnJTDXyvX1JoF3nbs2BJVOtgPXyMj4HAjh6Iebjb5M+0ZYj5VRd1weBbCNvk0OaP/LoYUd+sopHov/x9ToVXxeknE5APjujFbwqa1ry/0tzMdF5Sd2ErUGl2MTLy8gKmKtMTUegOAIYTKcECCFV4isecPYUDwrxCO113DkgP+IERADMleBHTiZp6rMHOCk4JdSIdNscvLfH9A1nx6QkVwVMYAzbIEtI4LfGtEgYNxta7KLFtPjceRDx+bl8+AWgQU3i9viJWTnpTm0Ku2f9UkllWwYpQqwQKBgQD+fis/LlWq+4nePRZ267DPBoYkvqfdHFHFTjhj+OWCwID3fvcObi/alKJXIWWu0xkNoVx4s82blA3SvnjcyrlIkqG8c6ep99ICq8e+DVeAAqIB/hSprMo3a11o8RZRwHOHYdkFrcGm2B4oDcOI53YWKFKm178B1Y5cMkuKHGmLrQKBgQDlovZbQEKyw1JALwLY3nkioEKdsWLh4aKjSfmQN1vylAdvyrFmP0n+KzCLCXmmyuLxKNZCkR/urJN9P/WTNRsLyc5NfoEYPk4RGIYV+Sc00HcEa5rG79HUv8gZyvK2p1Zo96TAPHOSNmQsw7fpgWKGq3GjzEOrzyi/jVCf9ww98QKBgQC0C1TTPReUgKJ4HOWwumv6+xWaF1ww/OEI4p7Yc3UD/OcAsc1dYyztyevUEqeaeHQoBXmjVylmIOdqqiBdq/pLUpmj9nqur8ne4+LLHStDQBmXqUa7B6iEbqvGG5H7wli5dcsQzm3LeOhU0+/7Ai2z3VEkAkx6org1l8uDaThufQKBgQChSRoa8UFnaQRGDD7Fr0wJY+Il+8blu6KNaZGdFyS/dfTbMdPzapQ/rnoDzX3iBjHrC7GhQ2jYK+HTYK7M28nJN85sY2OscWZHX6AdosdEsv5E3obxHtOTx7d1VjOu0k1AoF7YnhzWHtmxDy4HFVbsG1JPp1IIRBHsqAZutAenIQKBgQD82qngAIZYmHPKW1dzPn1JvHX7qriQsDLxPu7Y/8Nw0gsiaVXvsRAJBkz+SmSvCfdI9xZb+0D31UPATE6iqJQHfBYVAZFFAYC7eRVqVl3wgUP8/OV6mt43B0S0IHafMAEoJsbw/YNmosEVs97S1ji7V4Kz2Kj6no8xVi/zPcJfTw==

BiYongRSA公钥 (Base64-RFC4648):

    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5Ejdbta34zHYEv17L+g2HARP9vSu452KONCBhiK6ljSh/vFsSGuIY7QctLJM4HTcwVsdlnsyWG1tEznLRYQbJZ/6/BlHb2/ox5wqixYoUf6BVcAQx5Yosy50KJK29LmY8im47ZOqOXSCxeiaWuolTt0kVscW5KB+G+n+3cIsp+Vowf8HF8n/VTBAKt9NOYphKKSsLc0n4aRsPazuObciTNXuXRb+bhKX4OkH/OaZwqG4fAcCZL9WXnUoqLp8iq+s75skxt1HclL7IgoDjWpWsrZR//iMZSs/il08DUdhyuKx+QWKAo0fBoVAjBQf/XEZahMqg5tX/0M1uQDzXMC23QIDAQAB
    

为了您的账号安全，请务必自行生成RSA密钥，不要使用文档所提供的密钥！推荐使用2048长度密钥进行通信加密

请求 headers 可添加参数:

|key|value|备注|
|---|---|---|
|RsaSignHashMode|SHA256|可选，签名散列算法，不填默认SHA256，以下示例使用此散列算法

#### 进行 RSA 签名

时间戳`1525616709383`转换为 byte[8]:

    0000016335d78f07

随机生成 byte[16]`MessageId`:

    ee7f4e1af08a4952b73f07e2d7489c6d

传参为 JSON 格式，将 `{"message":"hello, BiYong"}` 转换为 byte[]:

    7b226d657373616765223a2268656c6c6f2c204269596f6e67227d
    
注意，如果接口参数也需要传入空的JSON`{}`字符串

拼接上述3条数据得到待加密的 `原始数据`:

    0000016335d78f07ee7f4e1af08a4952b73f07e2d7489c6d7b226d657373616765223a2268656c6c6f2c204269596f6e67227d

使用 `商户RSA私钥` 对 `原始数据` 进行RSA签名得到 `RSA签名`:

    73a306c905864028c5ab5bc25ca510450474e5b2a9de3d44525aa2528d98d935351939d7a4482f0ddd461fe69643b20ff14a43a89935a14a97a2b289d1eb911368e28fbc3caeba8b4cccf2aad214112c3cff49ebaea3beb188d91cfa247f243b5880c2c467f3ed646ca15b4179c7d4a4921141805301e7306a8b9b311b431ebb91b46321742f0b120fc685fea8b099eea1c29b2282209c56117c0b433ccc67ea87d7daab34bf4357daa63f384a43c1aa0750b3beb96c30bef2ccfdecf51b96e53f30bad958239dd69d666369fd493f74150cf70c3d95b42760382c0ebcf399101425a46c6123561207885b89cd9c25f1032966a2f2c07c3379251a036b59f987

将 `RSA签名` 的长度转为4byte `RSA签名长度`:

    00000100
    
拼接 `签名长度` `RSA签名` `原始数据` 得到 `RSA签名请求数据`:

    0000010073a306c905864028c5ab5bc25ca510450474e5b2a9de3d44525aa2528d98d935351939d7a4482f0ddd461fe69643b20ff14a43a89935a14a97a2b289d1eb911368e28fbc3caeba8b4cccf2aad214112c3cff49ebaea3beb188d91cfa247f243b5880c2c467f3ed646ca15b4179c7d4a4921141805301e7306a8b9b311b431ebb91b46321742f0b120fc685fea8b099eea1c29b2282209c56117c0b433ccc67ea87d7daab34bf4357daa63f384a43c1aa0750b3beb96c30bef2ccfdecf51b96e53f30bad958239dd69d666369fd493f74150cf70c3d95b42760382c0ebcf399101425a46c6123561207885b89cd9c25f1032966a2f2c07c3379251a036b59f9870000016335d78f07ee7f4e1af08a4952b73f07e2d7489c6d7b226d657373616765223a2268656c6c6f2c204269596f6e67227d

上述数据直接放在请求体内发送到 BiYong 服务器即可。

#### 进行 AES 加密 (可选)

请求 headers 可添加参数:

|key|value|备注|
|---|---|---|
|AesEncryptMode|CFB/NoPadding|可选，AES加密模式

- 如果填写了AES加密模式，请自行生成AES秘钥进行加密。此文档假设使用的AES KEY,IV 如下


    AES KEY (Hex):
    68b199b5713c8ff4472f5b7e0c996b0b
    AES IV (Hex):
    2268656c6c6f2c204269596f6e67227d

使用 AES/CFB/NoPadding 加密`RSA签名请求数据`，得到`AES加密数据`

    50d64c3fbf3f5052c3b5c441915bb7b710883586a3814a7e8041db6b4eeb87f573ab89449c455dc92c97c93398c8d829576527c736ed5985759fc5572bbd252fe978403d2b36ff72b360cac83700310df27c498a22684eba31111307ec2a53bcb1a73e502b9898ea4165694415135b550227c2decdec1c380b71ba407606ef3f8e320c7c0da65e37d5d9cf31d22fdeefce290933bb5fd15d5ca59b317a490f9b5bd15c2380e0f5881a10c0a1f37af201337ddd99614af683e5fee3d11ca402b195c17a720bd5afad3a8b1d0b4c85210515cba17b74248f34dacdc6ccf01c70aa47e1afcda24dc7e27bbe7b7d3e15f5d94ba119f9b34feb89d82487ca04b767ac280752ea2d3e9d392dce1191f5b67c7f336665a7dd95634e68f12bfc1ab3606122bf1b95663f71de80907898dd30ebce2b36ad849b9f95

使用 `BiYongRSA公钥` 加密 AES 秘钥(key + iv) 得到`RSA加密的AES秘钥`(此数据每次不同):

    b685049fe30a451b208a60744a0d4ab3aca31b6324bf6c05d6c660e0acc54290c1259c8d2a762cdc972056421d165a2c58f6ded28ef3621a2d8bc5268ec678aa83b5cdcd3b804a13ee298aabf512f5a0b6f49e3b5d0d43d42a479aa84c873aa148a2d4a87b1bf40aed792dee216daf2dd0f07f3eead51cb22adfefab8a9ddb87d1bcc9af2695a51c4315c5303694bf8d091fa0a66a1537328d58742a38d472fac2a07e76181339aae7e88e1f774777f3e84d576b02c9c659916e9897896732a1abb327c1b55ca011d0abfd9c7aafdfe81c7037caf9c88d5169fbfb75e3c25980995ae29e90d83fc5f5fc6fbf614144ad43b31936bad929d94563565e4efb302e
    
将 `RSA加密的AES秘钥` 长度转为byte[4] `RSA加密的AES秘钥长度`:

    00000100

`RSA加密的AES秘钥长度` + `RSA加密的AES秘钥` + `AES加密数据` = `AES加密请求数据`:

    00000100b685049fe30a451b208a60744a0d4ab3aca31b6324bf6c05d6c660e0acc54290c1259c8d2a762cdc972056421d165a2c58f6ded28ef3621a2d8bc5268ec678aa83b5cdcd3b804a13ee298aabf512f5a0b6f49e3b5d0d43d42a479aa84c873aa148a2d4a87b1bf40aed792dee216daf2dd0f07f3eead51cb22adfefab8a9ddb87d1bcc9af2695a51c4315c5303694bf8d091fa0a66a1537328d58742a38d472fac2a07e76181339aae7e88e1f774777f3e84d576b02c9c659916e9897896732a1abb327c1b55ca011d0abfd9c7aafdfe81c7037caf9c88d5169fbfb75e3c25980995ae29e90d83fc5f5fc6fbf614144ad43b31936bad929d94563565e4efb302e50d64c3fbf3f5052c3b5c441915bb7b710883586a3814a7e8041db6b4eeb87f573ab89449c455dc92c97c93398c8d829576527c736ed5985759fc5572bbd252fe978403d2b36ff72b360cac83700310df27c498a22684eba31111307ec2a53bcb1a73e502b9898ea4165694415135b550227c2decdec1c380b71ba407606ef3f8e320c7c0da65e37d5d9cf31d22fdeefce290933bb5fd15d5ca59b317a490f9b5bd15c2380e0f5881a10c0a1f37af201337ddd99614af683e5fee3d11ca402b195c17a720bd5afad3a8b1d0b4c85210515cba17b74248f34dacdc6ccf01c70aa47e1afcda24dc7e27bbe7b7d3e15f5d94ba119f9b34feb89d82487ca04b767ac280752ea2d3e9d392dce1191f5b67c7f336665a7dd95634e68f12bfc1ab3606122bf1b95663f71de80907898dd30ebce2b36ad849b9f95

### 2. 解析Response

接口返回的数据先判断`第一位是否为0`。

如果`第一位不为0x00`，接口调用失败，直接位转换为字符串即可读取错误信息

如果`第一位为0x00`，需要解码

如果发送请求采用了AES加密，返回的数据为 `AES加密Response`

    0050d64c3fb963d70ec0e6b1763e4be8311aafb365e735e9baf0c433738146d8a149dc3f2b52562e2ba986f5711a8947d00679c8a86e058404f5a697353bc3ce498b53701182fbe1316e9f737293ae4228ada42cd1e2ee2d2c06b17a1762464da93e70cc36efcb9b81088fb2caaf1fb7fc4bfb059bd8fbea9f6d2329ce728d0c63ab06af5c23348290c59d51e974a3e37128632d8cc71bb2e9c9896c02af4a76123019456c92c2eb67c6e308d2d72a630a51d3007b34d2c06694608799282f9446a9e954226215e55160efa766f32c454a52639bf31fb2ecead1fa9f2d2c67204d8bc4f695b1ee9d4f523486d660a82c2541252820dbd8b21f7fd93b7539f2cc23a84649b0b84c8b5cbef484e9506f3e4175c3e9f82ef30c997f4a7a362e2628ea4df1bb63da7a84ca2408176f922e6fc01489ac3ebcef3990efbe6f5dea85f1ca7732dbdb17eff3582b9eae5e4f4e23fe3b4328cbb07cb50f4c146d0ec6bf000ce1ae12

`AES加密Response`去除首位00，使用此次请求的AES密钥解密得到

    0000010075ff819506d5351f6abb04444c058481c5e5c72cb68c950f4bda757fe8f8ad19ab0646f32f758f388c71f52ad98651347ea28aa68b020ed453956da6c8c3e5db12a7ab65d4e29f11c11de1fcda0e69be85a933da9196f7a33ba357223add34e3de04708b6d14ae3117006898757acc1dc2ed0d0cfa5ad8e67af01058447c8c468464f80c0cb0e1d2219be3bcba5ef11723990e7fe71612745a9f1ee14a8913e32d5e99cd940567d29dc472862ccf7e96ccd19289a8b31ccb25b97362a49f07f4bf6146d3695f2e77a35aea80523b62fa3d835f7f1f11e892f1901e9b82cde15280ee290f0801fe53554ae28852b8c12554f9122bcac96ab0333fc84fdc064288ee7f4e1af08a4952b73f07e2d7489c6d7b2274696d657374616d70223a2231353235363136373039373830222c22737461747573223a2230222c2264617461223a7b226d657373616765223a2268656c6c6f2c204d65726368616e74227d7d

拆分为以下数据

    (RSA签名长度)
    00000100
    (BiYong私钥RSA签名)
    75ff819506d5351f6abb04444c058481c5e5c72cb68c950f4bda757fe8f8ad19ab0646f32f758f388c71f52ad98651347ea28aa68b020ed453956da6c8c3e5db12a7ab65d4e29f11c11de1fcda0e69be85a933da9196f7a33ba357223add34e3de04708b6d14ae3117006898757acc1dc2ed0d0cfa5ad8e67af01058447c8c468464f80c0cb0e1d2219be3bcba5ef11723990e7fe71612745a9f1ee14a8913e32d5e99cd940567d29dc472862ccf7e96ccd19289a8b31ccb25b97362a49f07f4bf6146d3695f2e77a35aea80523b62fa3d835f7f1f11e892f1901e9b82cde15280ee290f0801fe53554ae28852b8c12554f9122bcac96ab0333fc84fdc064288
    (MessageId)
    ee7f4e1af08a4952b73f07e2d7489c6d
    (Response数据)
    7b2274696d657374616d70223a2231353235363136373039373830222c22737461747573223a2230222c2264617461223a7b226d657373616765223a2268656c6c6f2c204d65726368616e74227d7d

RSA签名是使用 `MessageId` + `Response数据` 签名得到，散列算法为商户发送请求时选择的算法

Response数据直接转换为 JSON 字符串：

    {"timestamp":"1525616709780","status":"0","data":{"message":"hello, Merchant"}}

    

返回值统一格式：
    
    {
      "status":"0",                 // 0 代表接口请求成功
      "message":"",                 // 错误信息，请求成功无此字段
      "timestamp":"1525616709780",  // 时间戳
      "data": {}                    // JSON格式业务数据，每个接口返回数据格式请参考接口文档
    }

部分错误码：

|`status`|`描述`|
|---|---|
|100000|通用业务错误，具体信息参考 message|
|100100|调用异常|
|100101|商户无权访问此接口|
|100102|用户未授权商户访问此数据|
|100400|请求时间戳与服务器误差超过限制|
|100401|验签失败|
