# BiYong商户平台通信规范

## 商户平台升级

商户平台升级后，每个商户可以创建多个App。

请求头中的 MerchantId 字段变更为 AppId 字段。MerchantId 字段兼容旧版字段仍然可以使用。

## SDK

JAVA https://github.com/openbiyong/biyong-open-api-java

## 通信规范

所有接口调用均采用 https post

需要填写 headers:

|key|value|备注|
|---|---|---|
|Content-Type|application/json|传参格式为JSON
|AppId|d4743d2bd449468383a5417efa423541|AppID|

### 1. 发送 Request

- 商户请自行生成RSA秘钥对，将公钥上传至BiYong商户后台。此文档假设私钥-公钥对如下：


商户RSA私钥 (Base64-RFC4648):

    MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCGdHa2BsE65r/3YvzhGpsikKp7GsaFpKDex1Fzls8rxFfpa1NhZrwpsjJ09hmp0fwjxbcX8Qe6w7ndH5Sl1f6w5iwPebClKmX+Lfjz36dOBLVhnMfi6xdIKQ4lHNMQPKYE8GLJu7WuUqbeNWEUk73stjtyTFj8rvuzUZioM5YzWMleBvw353VRziOjbYFwrcilopT6EscJ0sB6WR5i4fF8AsFzeEO3FuJKyDGphcBXUN8VDpS2qb2LyZeVYKQVC6Sey7nYfOxIdJMM0dA6RLbi3bU4To6FKTk+3JRIOzQJpSCK+doZHi3aKLSmx5oKgNJf3BLsGJBegcPPDpzGDTodAgMBAAECggEAdaxGHQcKZE+BYLTMlwIfFgBAhB8p8drkRDVzLtOlGyvquMoKnms4cNGZYU3lpf+2SWSH2rdDSYx1BXbXNNB16EJ5+01IcTULMIrxoBZ0qU5rpDN/qTSRGsF7tLVmb4Z00kvEWcQjvJ5vlnhnL4giJ6JRorX5B6TpesYF8ee8I9DU4iQ/qJ8IsqAbFOwQGNXeIYTLMTKob2y68YWdRdi13TYRunDhDw9bb8qfi6Ckp9563SCwb04jp+0SiRhBG6rQQzVSMBHla58NF4xDSO22s9Or995JUOzhkrngqjP5WXZnbZwwbwduf4gz3cPONDGnfS9jaCfhnl0lIEbyeSJ9oQKBgQD5QNIhDBYqxjk6ptjjKKGvXyggzZ5JpFYrGHgyDJjVc4SeqPkBhrVg6xut38UJmJ40tLht3fFUnfgGzFUIg8mCiZPDb3v+UFIDtGdUvg8T9b1THRcfqN2Q2b9nADnbljumk7koKrME2DVp9cZD7ltrjMayXK/b75pibw1hhljflQKBgQCKGChtQ3zXFPUpcxfcW2sDziPPPy3cM1GXdOYJ/S5MxuVylCQBMxRNSWJPtaGqgkBN493i5dAjBl9O44kq5+Lo1RZyMDr8U0go62PVNH+DocDmvTAHFFy/+eiZB1/LexgrYYL3LZQ4TtF1V7XAPyE/bY2yCzN6EN5AM7u3kYnuaQKBgQDbY9/Q8MeOLN3wry1WfMwcBcDXZsT9guXJlwcs3oOj1cMUuBw86Ko7vZWmbMENGkWelLeFFQa3eTf4G+B41y8GdDwYmMdl6KLX2fHd2FCDPBjB0GgrGMK1HcRoT/2dN1YX4AzouvTJvdj+BDPYVTQorUezdPvhtbuJCsCXZ95QJQKBgB4/amN8e9TUt1qL5jcTIx6jQX68tPvdlcqaBWU8uq6AhnORdU159cF0CH+zJiUmAJXPCqQPeIajd67c8gee4TnkqtT6MYFhcJXd8XEa3a9kd89SszlpwWMfh041qkr0vHeMFVa0+hlXUlPkkV/5s/ujsHzGLVFYboYbjsuHqnG5AoGBAPU7WoSEZwwV3yQh2m/wsM0A+He/gKuqSd4JV8XNYzPeGLYmBQAoLvm8qJW4n1oJprk4S2zitOKRMTev/UXkkUSVHrOnzlSjZ33yd3ODIjkNWRFP03i5O4rX5MWCctQNMBg/ZJcbi8qGB2WDR6+3be4uf7zJOWAOonjv3bTiN0Ai
    
商户RSA公钥 (Base64-RFC4648):

    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAhnR2tgbBOua/92L84RqbIpCqexrGhaSg3sdRc5bPK8RX6WtTYWa8KbIydPYZqdH8I8W3F/EHusO53R+UpdX+sOYsD3mwpSpl/i3489+nTgS1YZzH4usXSCkOJRzTEDymBPBiybu1rlKm3jVhFJO97LY7ckxY/K77s1GYqDOWM1jJXgb8N+d1Uc4jo22BcK3IpaKU+hLHCdLAelkeYuHxfALBc3hDtxbiSsgxqYXAV1DfFQ6Utqm9i8mXlWCkFQuknsu52HzsSHSTDNHQOkS24t21OE6OhSk5PtyUSDs0CaUgivnaGR4t2ii0pseaCoDSX9wS7BiQXoHDzw6cxg06HQIDAQAB
    
BiYongRSA私钥 (Base64-RFC4648):

    MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDkSN1u1rfjMdgS/Xsv6DYcBE/29K7jnYo40IGGIrqWNKH+8WxIa4hjtBy0skzgdNzBWx2WezJYbW0TOctFhBsln/r8GUdvb+jHnCqLFihR/oFVwBDHliizLnQokrb0uZjyKbjtk6o5dILF6Jpa6iVO3SRWxxbkoH4b6f7dwiyn5WjB/wcXyf9VMEAq3005imEopKwtzSfhpGw9rO45tyJM1e5dFv5uEpfg6Qf85pnCobh8BwJkv1ZedSiounyKr6zvmyTG3UdyUvsiCgONalaytlH/+IxlKz+KXTwNR2HK4rH5BYoCjR8GhUCMFB/9cRlqEyqDm1f/QzW5APNcwLbdAgMBAAECggEAbZEnbo5yHgKLYbn1yS2b4uCS/MW9txOjBtfUguviQDus0O9Q+IVcJfaJnJTDXyvX1JoF3nbs2BJVOtgPXyMj4HAjh6Iebjb5M+0ZYj5VRd1weBbCNvk0OaP/LoYUd+sopHov/x9ToVXxeknE5APjujFbwqa1ry/0tzMdF5Sd2ErUGl2MTLy8gKmKtMTUegOAIYTKcECCFV4isecPYUDwrxCO113DkgP+IERADMleBHTiZp6rMHOCk4JdSIdNscvLfH9A1nx6QkVwVMYAzbIEtI4LfGtEgYNxta7KLFtPjceRDx+bl8+AWgQU3i9viJWTnpTm0Ku2f9UkllWwYpQqwQKBgQD+fis/LlWq+4nePRZ267DPBoYkvqfdHFHFTjhj+OWCwID3fvcObi/alKJXIWWu0xkNoVx4s82blA3SvnjcyrlIkqG8c6ep99ICq8e+DVeAAqIB/hSprMo3a11o8RZRwHOHYdkFrcGm2B4oDcOI53YWKFKm178B1Y5cMkuKHGmLrQKBgQDlovZbQEKyw1JALwLY3nkioEKdsWLh4aKjSfmQN1vylAdvyrFmP0n+KzCLCXmmyuLxKNZCkR/urJN9P/WTNRsLyc5NfoEYPk4RGIYV+Sc00HcEa5rG79HUv8gZyvK2p1Zo96TAPHOSNmQsw7fpgWKGq3GjzEOrzyi/jVCf9ww98QKBgQC0C1TTPReUgKJ4HOWwumv6+xWaF1ww/OEI4p7Yc3UD/OcAsc1dYyztyevUEqeaeHQoBXmjVylmIOdqqiBdq/pLUpmj9nqur8ne4+LLHStDQBmXqUa7B6iEbqvGG5H7wli5dcsQzm3LeOhU0+/7Ai2z3VEkAkx6org1l8uDaThufQKBgQChSRoa8UFnaQRGDD7Fr0wJY+Il+8blu6KNaZGdFyS/dfTbMdPzapQ/rnoDzX3iBjHrC7GhQ2jYK+HTYK7M28nJN85sY2OscWZHX6AdosdEsv5E3obxHtOTx7d1VjOu0k1AoF7YnhzWHtmxDy4HFVbsG1JPp1IIRBHsqAZutAenIQKBgQD82qngAIZYmHPKW1dzPn1JvHX7qriQsDLxPu7Y/8Nw0gsiaVXvsRAJBkz+SmSvCfdI9xZb+0D31UPATE6iqJQHfBYVAZFFAYC7eRVqVl3wgUP8/OV6mt43B0S0IHafMAEoJsbw/YNmosEVs97S1ji7V4Kz2Kj6no8xVi/zPcJfTw==

BiYongRSA公钥 (Base64-RFC4648):

    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5Ejdbta34zHYEv17L+g2HARP9vSu452KONCBhiK6ljSh/vFsSGuIY7QctLJM4HTcwVsdlnsyWG1tEznLRYQbJZ/6/BlHb2/ox5wqixYoUf6BVcAQx5Yosy50KJK29LmY8im47ZOqOXSCxeiaWuolTt0kVscW5KB+G+n+3cIsp+Vowf8HF8n/VTBAKt9NOYphKKSsLc0n4aRsPazuObciTNXuXRb+bhKX4OkH/OaZwqG4fAcCZL9WXnUoqLp8iq+s75skxt1HclL7IgoDjWpWsrZR//iMZSs/il08DUdhyuKx+QWKAo0fBoVAjBQf/XEZahMqg5tX/0M1uQDzXMC23QIDAQAB
    

为了您的账号安全，请务必自行生成RSA密钥，不要使用文档所提供的密钥！推荐使用2048长度密钥进行通信加密

请求 headers 可添加参数:

|key|value|备注|
|---|---|---|
|RsaSignHashMode|SHA256|可选，签名散列算法，不填默认SHA256，以下示例使用此散列算法

#### 进行 RSA 签名

时间戳`1525616709383`转换为 byte[8]:

    0000016335d78f07

随机生成 byte[16]`MessageId`:

    ee7f4e1af08a4952b73f07e2d7489c6d

传参为 JSON 格式，将 `{"message":"hello, BiYong"}` 转换为 byte[]:

    7b226d657373616765223a2268656c6c6f2c204269596f6e67227d

拼接上述3条数据得到待加密的 `原始数据`:

    0000016335d78f07ee7f4e1af08a4952b73f07e2d7489c6d7b226d657373616765223a2268656c6c6f2c204269596f6e67227d

使用 `商户RSA私钥` 对 `原始数据` 进行RSA签名得到 `RSA签名`:

    68b199b5713c8ff4472f5b7e0c996b0b33a8e83999b1c5436762617b24c20abbc0b02e65ddc303a8432f34c3c156fd8da231ae9fad291944a0fef18f5478175a25d4c14d3fe14f95cdbca90b8c2cd6589363c78ea7c643c2ca4005ff778bfb016811157e9730c12a2462a50b81438131169f4ec69dc51e38affdfef1af860307e90a75c40891f239bd196e58d39b166b3c426bc77d6c16bed84a5cc8c36b246f6039b993892da38e80c5d2ae9e005b3e275724fe5c3c4f22207138433a511a1b98e44c61976f15baa6843a7c7d74e46dc637d81a7658dafcc4f7e9423a32f905cb4e73ed48f3dbd48ff5e3f19275d642faecc6462f0d2e7ce09a2daa40ddd6da

将 `RSA签名` 的长度转为4byte `RSA签名长度`:

    00000100
    
拼接 `签名长度` `RSA签名` `原始数据` 得到 `RSA签名请求数据`:

    0000010068b199b5713c8ff4472f5b7e0c996b0b33a8e83999b1c5436762617b24c20abbc0b02e65ddc303a8432f34c3c156fd8da231ae9fad291944a0fef18f5478175a25d4c14d3fe14f95cdbca90b8c2cd6589363c78ea7c643c2ca4005ff778bfb016811157e9730c12a2462a50b81438131169f4ec69dc51e38affdfef1af860307e90a75c40891f239bd196e58d39b166b3c426bc77d6c16bed84a5cc8c36b246f6039b993892da38e80c5d2ae9e005b3e275724fe5c3c4f22207138433a511a1b98e44c61976f15baa6843a7c7d74e46dc637d81a7658dafcc4f7e9423a32f905cb4e73ed48f3dbd48ff5e3f19275d642faecc6462f0d2e7ce09a2daa40ddd6da0000016335d78f07ee7f4e1af08a4952b73f07e2d7489c6d7b226d657373616765223a2268656c6c6f2c204269596f6e67227d

上述数据直接放在请求体内发送到 BiYong 服务器即可。

#### 进行 AES 加密 (可选)

请求 headers 可添加参数:

|key|value|备注|
|---|---|---|
|AesEncryptMode|CFB/NoPadding|可选，AES加密模式

- 如果填写了AES加密模式，请自行生成AES秘钥进行加密。此文档假设使用的AES KEY,IV 如下


    AES KEY (Hex):
    68b199b5713c8ff4472f5b7e0c996b0b
    AES IV (Hex):
    2268656c6c6f2c204269596f6e67227d

使用 AES/CFB/NoPadding 加密`RSA签名请求数据`，得到`AES加密数据`

    50d64c3fa42dcf2eb70f0b9d13dfb70be15970d2b769c08f3392238a17ec7b2d4eea16e4b533444d8b49c17082d8c4bc6d4ab14839fdb06678daa2efe2709069d801baad1e87bc55649f791b5021aea74d3fbf14bc26aded2003e5948d2095e98f6a83e3d848244afc43202f791ea34fa44882fe1fa50eb243136ab563b2a297c79b38c864e62f0de4717e9fdcff0d804f055f8ef5c22291cc6a2c8acad2091f7279cfe1ac29095fa3f86f2cc35c1dd2da11457ef7b7eb4a24ba8cb5b34849b0f253dada86e91979896f14c4f37ff1e92cbe02b987907ffc960c78025f98496531ef8e8697a6c097727f5b806e634b1c6710f7cbae06866c9f26a9225d319bcbbbc6286ed64874e831f18c31a76779e5492dca3de2acf6670c01ea0e6c8a9a1c5664608c5e5f8f3a4d0557ae82934949bcfdcee0a5244c

使用 `BiYongRSA公钥` 加密 AES 秘钥(key + iv) 得到`RSA加密的AES秘钥`:

    b685049fe30a451b208a60744a0d4ab3aca31b6324bf6c05d6c660e0acc54290c1259c8d2a762cdc972056421d165a2c58f6ded28ef3621a2d8bc5268ec678aa83b5cdcd3b804a13ee298aabf512f5a0b6f49e3b5d0d43d42a479aa84c873aa148a2d4a87b1bf40aed792dee216daf2dd0f07f3eead51cb22adfefab8a9ddb87d1bcc9af2695a51c4315c5303694bf8d091fa0a66a1537328d58742a38d472fac2a07e76181339aae7e88e1f774777f3e84d576b02c9c659916e9897896732a1abb327c1b55ca011d0abfd9c7aafdfe81c7037caf9c88d5169fbfb75e3c25980995ae29e90d83fc5f5fc6fbf614144ad43b31936bad929d94563565e4efb302e
    
将 `RSA加密的AES秘钥` 长度转为byte[4] `RSA加密的AES秘钥长度`:

    00000100

`RSA加密的AES秘钥长度` + `RSA加密的AES秘钥` + `AES加密数据` = `AES加密请求数据`:

    00000100b685049fe30a451b208a60744a0d4ab3aca31b6324bf6c05d6c660e0acc54290c1259c8d2a762cdc972056421d165a2c58f6ded28ef3621a2d8bc5268ec678aa83b5cdcd3b804a13ee298aabf512f5a0b6f49e3b5d0d43d42a479aa84c873aa148a2d4a87b1bf40aed792dee216daf2dd0f07f3eead51cb22adfefab8a9ddb87d1bcc9af2695a51c4315c5303694bf8d091fa0a66a1537328d58742a38d472fac2a07e76181339aae7e88e1f774777f3e84d576b02c9c659916e9897896732a1abb327c1b55ca011d0abfd9c7aafdfe81c7037caf9c88d5169fbfb75e3c25980995ae29e90d83fc5f5fc6fbf614144ad43b31936bad929d94563565e4efb302e50d64c3fa42dcf2eb70f0b9d13dfb70be15970d2b769c08f3392238a17ec7b2d4eea16e4b533444d8b49c17082d8c4bc6d4ab14839fdb06678daa2efe2709069d801baad1e87bc55649f791b5021aea74d3fbf14bc26aded2003e5948d2095e98f6a83e3d848244afc43202f791ea34fa44882fe1fa50eb243136ab563b2a297c79b38c864e62f0de4717e9fdcff0d804f055f8ef5c22291cc6a2c8acad2091f7279cfe1ac29095fa3f86f2cc35c1dd2da11457ef7b7eb4a24ba8cb5b34849b0f253dada86e91979896f14c4f37ff1e92cbe02b987907ffc960c78025f98496531ef8e8697a6c097727f5b806e634b1c6710f7cbae06866c9f26a9225d319bcbbbc6286ed64874e831f18c31a76779e5492dca3de2acf6670c01ea0e6c8a9a1c5664608c5e5f8f3a4d0557ae82934949bcfdcee0a5244c

### 2. 解析Response

接口返回的数据先判断`第一位是否为0`。

如果`第一位不为0x00`，接口调用失败，直接位转换为字符串即可读取错误信息

如果`第一位为0x00`，需要解码

如果发送请求采用了AES加密，返回的数据为 `AES加密Response`

    0050d64c3f81004c71b90002d27b8c63116534279f2537a528889a65f961478106ea9d11162b8e43259af691c9297db5d28b2ada8f1c57b92d075e013f79046334ff9ba551a5625518cd77069dbf40204ebcd48e0c1236b29a419b46a13b1918ceaea96bd094de29a712babfbf0e68aa4da1ea3faf7b489d78cb0797d6c44de47bef48a5a6138671b6cd998c4ee22aee516c6912149138a09d3210e9fd3a30426e03e227c868c4690065cebc53932f380694c3300645034ab4598942af302e7a775f919b75a19514176d71619dcf388d170e1d28cae25eb3f7e92b3d5447e82b24d8e8efd5b8e9a5720330abbb215673b446a3d52a5554e1e4394aad4727071da2faff47094c7628974ede526c8d2692be11d51f10a9a5bbb59bc5b18481682a73703f2db9ad2e2eb00adcddcdb7a9a5af77cd2e76ed108b5bd59774b49d1aa812f7c13b0f9de4301029de1259d9b2649264ee19b1f765e2a454ea91aa8cbc9fbfa718ed

`AES加密Response`去除首位00，使用此次请求的AES密钥解密得到

    000001004d9c1aea7f3386bb2f7c8f6404c181c12bf6d14c223a23971d53cd81e009d9148839e4b597ded681002e227fff1ce71df3f361d50730008196de77add1de0173287470710c5240a83542d2505b161dc060544fbe7c0770a7b11214409baed23a79acbb384c8c3e2b376b3a74ac1c2199ccb2fe23c9982bbd78fd1558ddd811a1c2fbbc73f9e3c01147ecc41d1ac7d91cf0ce2ca4becd3d770b7e59ae0e78a56f68cc406af3287525ddc8811efa662e7d5575875deeac462917380968aa5f510ba6534ef9de85a85bbef47b869c21c4da6f189d129133d9c160eba578c80b06ed87eb1e6be3299485fe6f08bd10df0f9aabdf7c860d463b22f3f2a8b622595d48ee7f4e1af08a4952b73f07e2d7489c6d7b2274696d657374616d70223a2231353235363136373039373830222c22737461747573223a2230222c2264617461223a7b226d657373616765223a2268656c6c6f2c204d65726368616e74227d7d

拆分为以下数据

    (RSA签名长度)
    00000100
    (BiYong私钥RSA签名)
    4d9c1aea7f3386bb2f7c8f6404c181c12bf6d14c223a23971d53cd81e009d9148839e4b597ded681002e227fff1ce71df3f361d50730008196de77add1de0173287470710c5240a83542d2505b161dc060544fbe7c0770a7b11214409baed23a79acbb384c8c3e2b376b3a74ac1c2199ccb2fe23c9982bbd78fd1558ddd811a1c2fbbc73f9e3c01147ecc41d1ac7d91cf0ce2ca4becd3d770b7e59ae0e78a56f68cc406af3287525ddc8811efa662e7d5575875deeac462917380968aa5f510ba6534ef9de85a85bbef47b869c21c4da6f189d129133d9c160eba578c80b06ed87eb1e6be3299485fe6f08bd10df0f9aabdf7c860d463b22f3f2a8b622595d48
    (商户传送的MessageId)
    ee7f4e1af08a4952b73f07e2d7489c6d
    (Response数据)
    7b2274696d657374616d70223a2231353235363136373039373830222c22737461747573223a2230222c2264617461223a7b226d657373616765223a2268656c6c6f2c204d65726368616e74227d7d

RSA签名是使用 `MessageId` + `Response数据` 签名得到，散列算法为商户发送请求时选择的算法

Response数据直接转换为 JSON 字符串：

    {"timestamp":"1525616709780","status":"0","data":{"message":"hello, Merchant"}}

    

返回值统一格式：
    
    {
      "status":"0",                 // 0 代表接口请求成功
      "message":"",                 // 错误信息，请求成功无此字段
      "timestamp":"1525616709780",  // 时间戳
      "data": {}                    // JSON格式业务数据，每个接口返回数据格式请参考接口文档
    }

部分错误码：

|`status`|`描述`|
|---|---|
|100000|通用业务错误，具体信息参考 message|
|100100|调用异常|
|100101|商户无权访问此接口|
|100102|用户未授权商户访问此数据|
|100400|请求时间戳与服务器误差超过限制|
|100401|验签失败|
